## Question 01

使用 `strace` 跟踪捕获 `bpf()` 系统调用，以此运行示例代码，命令如下：`strace -e bpf -o outfile ./hello`

该命令会将每次 `bpf()` 系统调用的相关信息记录到名为 `outfile` 的文件中。

在该文件中查找 `BPF_PROG_LOAD` 相关指令，观察不同程序对应的 `prog_type` 字段取值有何不同。你可以通过跟踪日志中的 `prog_name` 字段区分各个程序，并将其与 `chapter7/hello.bpf.c` 中的源代码一一对应。

## Answer

1. 代码修改

```diff
@@ -42,7 +42,7 @@ int BPF_KPROBE_SYSCALL(kprobe_sys_execve, const char *pathname)

 // TODO!! Work on ARM
 #ifndef __TARGET_ARCH_arm64
-SEC("kprobe/do_execve")
+SEC("kprobe/__x64_sys_execve")
 int BPF_KPROBE(kprobe_do_execve, struct filename *filename) {
    struct data_t data = {};

@@ -65,7 +65,7 @@ int BPF_KPROBE(kprobe_do_execve, struct filename *filename) {
 // This should really look at the kernel version, because fentry is supported on
 // ARM from Linux 6.0 onwards
 #ifndef __TARGET_ARCH_arm64
-SEC("fentry/do_execve")
+SEC("fentry/__x64_sys_execve")
 int BPF_PROG(fentry_execve, struct filename *filename) {
    struct data_t data = {};
```

2. 运行

```sh
$ cd learning-ebpf/chapter7
$ make
$ strace -e bpf -o outfile ./hello
```

3. 查看 outfile 文件

<details>
<summary>$ cat outfile</summary>

```sh
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=2, insns=0x7fff2bb964e0, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0, attach_prog_fd=0}, 116) = 3
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=2, insns=0x7fff2bb966f0, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0\20\0\0\0\20\0\0\0\5\0\0\0\1\0\0\0\0\0\0\1"..., btf_log_buf=NULL, btf_size=45, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0000\0\0\0000\0\0\0\t\0\0\0\1\0\0\0\0\0\0\1"..., btf_log_buf=NULL, btf_size=81, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\08\0\0\08\0\0\0\t\0\0\0\0\0\0\0\0\0\0\1"..., btf_log_buf=NULL, btf_size=89, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0\f\0\0\0\f\0\0\0\7\0\0\0\1\0\0\0\0\0\0\20"..., btf_log_buf=NULL, btf_size=43, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0000\0\0\0000\0\0\0\t\0\0\0\1\0\0\0\0\0\0\1"..., btf_log_buf=NULL, btf_size=81, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0000\0\0\0000\0\0\0\5\0\0\0\0\0\0\0\0\0\0\1"..., btf_log_buf=NULL, btf_size=77, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0(\0\0\0(\0\0\0\5\0\0\0\0\0\0\0\0\0\0\1"..., btf_log_buf=NULL, btf_size=69, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0\f\0\0\0\f\0\0\0\10\0\0\0\1\0\0\0\0\0\0\23"..., btf_log_buf=NULL, btf_size=44, btf_log_size=0, btf_log_level=0}, 28) = 3
bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0`\t\0\0`\t\0\0\260\v\0\0\0\0\0\0\0\0\0\2"..., btf_log_buf=0x7fff2bb968e0, btf_size=5416, btf_log_size=65536, btf_log_level=1}, 28) = 3
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=2, insns=0x7fff2bb963e0, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="libbpf_nametest"}, 64) = 4
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_ARRAY, key_size=4, value_size=4, max_entries=1, map_flags=BPF_F_MMAPABLE, inner_map_fd=0, map_name="libbpf_mmap", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 4
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_PERF_EVENT_ARRAY, key_size=4, value_size=4, max_entries=8, map_flags=0, inner_map_fd=0, map_name="output", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 4
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_HASH, key_size=4, value_size=12, max_entries=10240, map_flags=0, inner_map_fd=0, map_name="my_config", map_ifindex=0, btf_fd=3, btf_key_type_id=12, btf_value_type_id=16, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 5
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_ARRAY, key_size=4, value_size=32, max_entries=1, map_flags=0, inner_map_fd=0, map_name="libbpf_global", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 6
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=5, insns=0x7fff2bb963b0, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 7
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_ARRAY, key_size=4, value_size=185, max_entries=1, map_flags=BPF_F_RDONLY_PROG|BPF_F_MMAPABLE, inner_map_fd=0, map_name="hello_bp.rodata", map_ifindex=0, btf_fd=3, btf_key_type_id=0, btf_value_type_id=88, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 6
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=6, key=0x7fff2bb964dc, value=0x7c5f4bfb0000, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_FREEZE, {map_fd=6}, 4)      = 0
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_ARRAY, key_size=4, value_size=1, max_entries=1, map_flags=BPF_F_RDONLY_PROG|BPF_F_MMAPABLE, inner_map_fd=0, map_name="hello_b.kconfig", map_ifindex=0, btf_fd=3, btf_key_type_id=0, btf_value_type_id=86, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 7
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=7, key=0x7fff2bb964dc, value=0x7c5f4bfaf000, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_FREEZE, {map_fd=7}, 4)      = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_TRACEPOINT, insn_cnt=6, insns=0x7fff2bb965a0, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 8
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_KPROBE, insn_cnt=102, insns=0x5619d11b0e50, license="Dual BSD/GPL", log_level=1, log_size=65536, log_buf="magic: 0xeb9f\nversion: 1\nflags: "..., kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="kprobe_sys_exec", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=3, func_info_rec_size=8, func_info=0x5619d11afa50, func_info_cnt=1, line_info_rec_size=16, line_info=0x5619d11afc60, line_info_cnt=34, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 8
bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_ARRAY, key_size=4, value_size=32, max_entries=1, map_flags=0, inner_map_fd=0, map_name="libbpf_det_bind", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 9
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=2, insns=0x7fff2bb95bf0, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 10
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=10, map_fd=9, flags=0}}, 12) = 0
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=8, map_fd=6, flags=0}}, 12) = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_KPROBE, insn_cnt=56, insns=0x5619d11b1360, license="Dual BSD/GPL", log_level=1, log_size=65536, log_buf="processed 55 insns (limit 100000"..., kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="kprobe_do_execv", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=3, func_info_rec_size=8, func_info=0x5619d11afbe0, func_info_cnt=1, line_info_rec_size=16, line_info=0x5619d11afe90, line_info_cnt=20, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 9
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=9, map_fd=6, flags=0}}, 12) = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_TRACING, insn_cnt=56, insns=0x5619d11b17c0, license="Dual BSD/GPL", log_level=1, log_size=65536, log_buf="processed 51 insns (limit 100000"..., kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="fentry_execve", prog_ifindex=0, expected_attach_type=BPF_TRACE_FENTRY, prog_btf_fd=3, func_info_rec_size=8, func_info=0x5619d11afa00, func_info_cnt=1, line_info_rec_size=16, line_info=0x5619d11affe0, line_info_cnt=20, attach_btf_id=40953, attach_prog_fd=0, fd_array=NULL}, 128) = 10
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=10, map_fd=6, flags=0}}, 12) = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_TRACEPOINT, insn_cnt=47, insns=0x5619d11b1cf0, license="Dual BSD/GPL", log_level=1, log_size=65536, log_buf="processed 51 insns (limit 100000"..., kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="tp_sys_enter_ex", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=3, func_info_rec_size=8, func_info=0x5619d11af940, func_info_cnt=1, line_info_rec_size=16, line_info=0x5619d11b0130, line_info_cnt=17, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 11
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=11, map_fd=6, flags=0}}, 12) = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_TRACING, insn_cnt=31, insns=0x5619d11b2290, license="Dual BSD/GPL", log_level=1, log_size=65536, log_buf="processed 42 insns (limit 100000"..., kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="tp_btf_exec", prog_ifindex=0, expected_attach_type=BPF_TRACE_RAW_TP, prog_btf_fd=3, func_info_rec_size=8, func_info=0x5619d11afba0, func_info_cnt=1, line_info_rec_size=16, line_info=0x5619d11b0250, line_info_cnt=11, attach_btf_id=17997, attach_prog_fd=0, fd_array=NULL}, 128) = 12
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=12, map_fd=6, flags=0}}, 12) = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_RAW_TRACEPOINT, insn_cnt=31, insns=0x5619d11b2870, license="Dual BSD/GPL", log_level=1, log_size=65536, log_buf="processed 28 insns (limit 100000"..., kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="raw_tp_exec", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=3, func_info_rec_size=8, func_info=0x5619d11afbc0, func_info_cnt=1, line_info_rec_size=16, line_info=0x5619d11b0310, line_info_cnt=11, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 13
bpf(BPF_PROG_BIND_MAP, {prog_bind_map={prog_fd=13, map_fd=6, flags=0}}, 12) = 0
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_TRACEPOINT, insn_cnt=2, insns=0x7fff2bb96210, license="GPL", log_level=0, log_size=0, log_buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS, prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 128) = 15
bpf(BPF_LINK_CREATE, {link_create={prog_fd=15, target_fd=-1, attach_type=BPF_PERF_EVENT, flags=0, perf_event={bpf_cookie=0}}}, 48) = -1 EBADF (Bad file descriptor)
bpf(BPF_LINK_CREATE, {link_create={prog_fd=8, target_fd=14, attach_type=BPF_PERF_EVENT, flags=0, perf_event={bpf_cookie=0}}}, 48) = 15
bpf(BPF_LINK_CREATE, {link_create={prog_fd=9, target_fd=16, attach_type=BPF_PERF_EVENT, flags=0, perf_event={bpf_cookie=0}}}, 48) = 17
bpf(BPF_LINK_CREATE, {link_create={prog_fd=10, target_fd=0, attach_type=BPF_TRACE_FENTRY, flags=0}}, 48) = 18
bpf(BPF_LINK_CREATE, {link_create={prog_fd=11, target_fd=19, attach_type=BPF_PERF_EVENT, flags=0, perf_event={bpf_cookie=0}}}, 48) = 20
bpf(BPF_LINK_CREATE, {link_create={prog_fd=12, target_fd=0, attach_type=BPF_TRACE_RAW_TP, flags=0}}, 48) = 21
bpf(BPF_RAW_TRACEPOINT_OPEN, {raw_tracepoint={name="sched_process_exec", prog_fd=13}}, 16) = 22
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=4, info_len=88, info=0x7fff2bb96610}}, 16) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b58d0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b5910, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b5950, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b5990, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b59d0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b5a10, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b5a50, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x7fff2bb96604, value=0x5619d11b5a90, flags=BPF_ANY}, 32) = 0
--- SIGINT {si_signo=SIGINT, si_code=SI_KERNEL} ---
+++ killed by SIGINT +++
```

</details>
