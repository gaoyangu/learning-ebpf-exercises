## Question 06

运行 BCC 工具集中 libbpf 工具套件里的 `opensnoop` 应用程序。该工具会创建一些 BPF 链接，你可以通过 bpftool 工具查看这些链接，命令如下：

```sh
$ bpftool link list
116: perf_event prog 1849
        bpf_cookie 0
        pids opensnoop(17711)
117: perf_event prog 1851
        bpf_cookie 0
        pids opensnoop(17711)
```

请确认程序 ID（在我此处的示例输出中为 1849 和 1851）与已加载 eBPF 程序列表的输出结果一致。

```sh
$ bpftool prog list
...
1849: tracepoint name tracepoint__syscalls__sys_enter_openat
        tag 8ee3432dcd98ffc3 gpl run_time_ns 95875 run_cnt 121
        loaded_at 2023-01-08T15:49:54+0000 uid 0
        xlated 240B jited 264B memlock 4096B map_ids 571,568
        btf_id 710
        pids opensnoop(17711)
1851: tracepoint name tracepoint__syscalls__sys_exit_openat
        tag 387291c2fb839ac6 gpl run_time_ns 8515669 run_cnt 120
        loaded_at 2023-01-08T15:49:54+0000 uid 0
        xlated 696B jited 744B memlock 4096B map_ids 568,571,569
        btf_id 710
        pids opensnoop(17711)
```

## Answer

1. 安装 BCC

```sh
$ apt install bpfcc-tools
```

2. 查看 BCC 小工具

```sh
$ ls -l /sbin/*-bpfcc | more
```

3. 运行 opensnoop
    - 监控节点上所有打开文件的操作
```sh
$ opensnoop-bpfcc
```

4. 运行 `bpftool link list`

```sh
$ bpftool link list
...
11: tracing  prog 99
        prog_type tracing  attach_type trace_fexit
        target_obj_id 1  target_btf_id 40424
12: tracing  prog 100
        prog_type tracing  attach_type trace_fexit
        target_obj_id 1  target_btf_id 40422
13: tracing  prog 101
        prog_type tracing  attach_type trace_fexit
        target_obj_id 1  target_btf_id 40420
```

5. 运行 `bpftool prog list`

```sh
$ bpftool prog list
...
99: tracing  name __x64_sys_open  tag 3ee01422231d9ef5  gpl
        loaded_at 2025-12-24T15:12:03+0800  uid 0
        xlated 600B  jited 485B  memlock 4096B  map_ids 59
        btf_id 84
100: tracing  name kretfunc__vmlinux____x64_sys_openat  tag 2a5259bf6ea85d47  gpl
        loaded_at 2025-12-24T15:12:03+0800  uid 0
        xlated 600B  jited 485B  memlock 4096B  map_ids 59
        btf_id 84
101: tracing  name kretfunc__vmlinux____x64_sys_openat2  tag f360e85b6bb0e8f5  gpl
        loaded_at 2025-12-24T15:12:04+0800  uid 0
        xlated 640B  jited 557B  memlock 4096B  map_ids 59
        btf_id 84
```

## References

- [加餐06 BCC：入门eBPF的前端工具](https://learn.lianglianglee.com/%e4%b8%93%e6%a0%8f/%e5%ae%b9%e5%99%a8%e5%ae%9e%e6%88%98%e9%ab%98%e6%89%8b%e8%af%be/%e5%8a%a0%e9%a4%9006%20BCC%ef%bc%9a%e5%85%a5%e9%97%a8eBPF%e7%9a%84%e5%89%8d%e7%ab%af%e5%b7%a5%e5%85%b7.md)
