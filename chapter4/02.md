## Question 02

运行该示例程序的两个实例，这样就会存在两个名为 config 的映射。如果执行 `bpftool map dump name config` 命令，输出内容会包含这两个不同映射的相关信息及其存储的数据。在 strace 工具下运行这条命令，跟踪系统调用输出中不同文件描述符的使用过程。你能否从中看出程序是在何处获取映射自身的信息，以及何处获取存储在映射内的键值对？

## Answer

1. 运行 `hello-buffer-config.py`

```sh
$ cd chapter4
$ ./hello-buffer-config.py
```

2. 运行 `hello-ring-buffer-config.py`

```sh
$ cd chapter4
$ ./hello-ring-buffer-config.py
```

3. 使用 strace 工具执行 `bpftool map dump name config`

```sh
$ strace -e bpf bpftool map dump name config
# 1. 遍历所有映射，查找所有名称为 `config` 的映射。
bpf(BPF_MAP_GET_NEXT_ID, {start_id=0, next_id=0 => 10, open_flags=0}, 12) = 0
bpf(BPF_MAP_GET_FD_BY_ID, {map_id=10, next_id=0, open_flags=BPF_F_RDONLY}, 12) = 3
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=3, info_len=104 => 88, info=0x7ffe12191aa0}}, 16) = 0
...
bpf(BPF_MAP_GET_NEXT_ID, {start_id=49, next_id=0, open_flags=0}, 12) = -1 ENOENT (No such file or directory)

# 2. 若找到匹配的映射，则遍历该映射内的所有元素。
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=3, info_len=104 => 88, info=0x7ffe12191c60}}, 16) = 0
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=4, info_len=88, info=0x7ffe12191c60}}, 16) = 0

# 2.1 遍历文件描述符 3 对应的 map
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=3, info_len=104 => 88, info=0x7ffe12191bf0}}, 16) = 0
bpf(BPF_BTF_GET_FD_BY_ID, {btf_id=68}, 16) = 5
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=5, info_len=32, info=0x7ffe12191a90}}, 16) = 0
[{
        "id": 47,
        "type": "hash",
        "name": "config",
        "flags": 0,
bpf(BPF_MAP_GET_NEXT_KEY, {map_fd=3, key=NULL, next_key=0x63a9f331d6f0}, 24) = 0
bpf(BPF_MAP_LOOKUP_ELEM, {map_fd=3, key=0x63a9f331d6f0, value=0x63a9f331d710, flags=BPF_ANY}, 32) = 0
        "elements": [{
                "key": 1000,
                "value": {
                    "message": [72,105,32,117,115,101,114,32,49,48,48,48,33
                    ]
                }
bpf(BPF_MAP_GET_NEXT_KEY, {map_fd=3, key=0x63a9f331d6f0, next_key=0x63a9f331d6f0}, 24) = 0
bpf(BPF_MAP_LOOKUP_ELEM, {map_fd=3, key=0x63a9f331d6f0, value=0x63a9f331d710, flags=BPF_ANY}, 32) = 0
            },{
                "key": 0,
                "value": {
                    "message": "Hey root!"
                }
bpf(BPF_MAP_GET_NEXT_KEY, {map_fd=3, key=0x63a9f331d6f0, next_key=0x63a9f331d6f0}, 24) = -1 ENOENT (No such file or directory)
            }
        ]

# 2.2 遍历文件描述符 4 对应的 map
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=4, info_len=88, info=0x7ffe12191bf0}}, 16) = 0
bpf(BPF_BTF_GET_FD_BY_ID, {btf_id=70}, 16) = 3
bpf(BPF_OBJ_GET_INFO_BY_FD, {info={bpf_fd=3, info_len=32, info=0x7ffe12191a90}}, 16) = 0
    },{
        "id": 49,
        "type": "hash",
        "name": "config",
        "flags": 0,
bpf(BPF_MAP_GET_NEXT_KEY, {map_fd=4, key=NULL, next_key=0x63a9f331d710}, 24) = 0
bpf(BPF_MAP_LOOKUP_ELEM, {map_fd=4, key=0x63a9f331d710, value=0x63a9f331d6f0, flags=BPF_ANY}, 32) = 0
        "elements": [{
                "key": 0,
                "value": {
                    "message": "Hey root!"
                }
bpf(BPF_MAP_GET_NEXT_KEY, {map_fd=4, key=0x63a9f331d710, next_key=0x63a9f331d710}, 24) = -1 ENOENT (No such file or directory)
            }
        ]
    }
]
+++ exited with 0 +++
```