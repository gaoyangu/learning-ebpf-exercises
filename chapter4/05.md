## Question 05

相较于挂载到 kprobe，在系统调用层面挂载到原始跟踪点（raw tracepoint） 的操作要简单得多，因为这一过程仅需调用一次 `bpf()` 系统调用即可完成。

请尝试修改 `hello-buffer-config.py` 程序，使其通过 BCC 提供的 `RAW_TRACEPOINT_PROBE` 宏，挂载到 `sys_enter` 对应的原始跟踪点（如果你完成了第二章的练习题，应该已经有一个可以直接复用的程序了）。你无需在 Python 代码中显式编写挂载程序的逻辑，BCC 库会自动帮你处理好这一步。

在 strace 工具下运行修改后的程序，你应该会看到一条类似这样的系统调用记录：

```sh
bpf(BPF_RAW_TRACEPOINT_OPEN, {raw_tracepoint={name="sys_enter", prog_fd=6}}, 128) = 7
```

内核中的跟踪点名为 `sys_enter`，文件描述符为 6 的 eBPF 程序正被挂载到该跟踪点上。从现在开始，每当内核中的执行流程到达这个跟踪点时，就会触发该 eBPF 程序运行。

## Answer

1. 代码修改

```py
#!/usr/bin/python3  
# -*- coding: utf-8 -*-
from bcc import BPF
import ctypes as ct

program = r"""
struct user_msg_t {
   char message[13];
};

BPF_HASH(config, u32, struct user_msg_t);

BPF_PERF_OUTPUT(output); 

struct data_t {     
   int pid;
   int uid;
   char command[16];
   char message[12];
};

int hello(void *ctx) {
   struct data_t data = {}; 
   struct user_msg_t *p;
   char message[12] = "Hello World";

   data.pid = bpf_get_current_pid_tgid() >> 32;
   data.uid = bpf_get_current_uid_gid() & 0xFFFFFFFF;

   bpf_get_current_comm(&data.command, sizeof(data.command));

   p = config.lookup(&data.uid);
   if (p != 0) {
      bpf_probe_read_kernel(&data.message, sizeof(data.message), p->message);       
   } else {
      bpf_probe_read_kernel(&data.message, sizeof(data.message), message); 
   }

   output.perf_submit(ctx, &data, sizeof(data)); 
 
   return 0;
}
"""

b = BPF(text=program) 
b.attach_raw_tracepoint(tp="sys_enter", fn_name="hello")

b["config"][ct.c_int(0)] = ct.create_string_buffer(b"Hey root!")
b["config"][ct.c_int(1000)] = ct.create_string_buffer(b"Hi user 1000!")
 
def print_event(cpu, data, size):  
   data = b["output"].event(data)
   print(f"{data.pid} {data.uid} {data.command.decode()} {data.message.decode()}")
 
b["output"].open_perf_buffer(print_event) 
while True:   
   b.perf_buffer_poll()
```

2. strace 输出

```sh
$ strace -e bpf ./hello-buffer-config.py
bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=2, insns=0x7ffc708432b0, license="GPL", log_level=0, log_size=0, log_
buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_INGRESS,
 prog_btf_fd=0, func_info_rec_size=0, func_info=NULL, func_info_cnt=0, line_info_rec_size=0, line_info=NULL, line_info_cnt=0, attach_btf_
id=0, attach_prog_fd=0}, 116) = 3

bpf(BPF_BTF_LOAD, {btf="\237\353\1\0\30\0\0\0\0\0\0\0\374\4\0\0\374\4\0\0\340\3\0\0\1\0\0\0\0\0\0\10"..., btf_log_buf=NULL, btf_size=2292
, btf_log_size=0, btf_log_level=0}, 32) = 3

bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_SOCKET_FILTER, insn_cnt=2, insns=0x7ffc70842f60, license="GPL", log_level=0, log_size=0, log_
buf=NULL, kern_version=KERNEL_VERSION(0, 0, 0), prog_flags=0, prog_name="libbpf_nametest"}, 64) = 4

bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_PERF_EVENT_ARRAY, key_size=4, value_size=4, max_entries=8, map_flags=0, inner_map_fd=0, map_na
me="output", map_ifindex=0, btf_fd=0, btf_key_type_id=0, btf_value_type_id=0, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 4

bpf(BPF_MAP_CREATE, {map_type=BPF_MAP_TYPE_HASH, key_size=4, value_size=13, max_entries=10240, map_flags=0, inner_map_fd=0, map_name="con
fig", map_ifindex=0, btf_fd=3, btf_key_type_id=1, btf_value_type_id=4, btf_vmlinux_value_type_id=0, map_extra=0}, 72) = 5

bpf(BPF_PROG_LOAD, {prog_type=BPF_PROG_TYPE_RAW_TRACEPOINT, insn_cnt=47, insns=0x71ccc721d000, license="GPL", log_level=0, log_size=0, lo
g_buf=NULL, kern_version=KERNEL_VERSION(6, 6, 87), prog_flags=0, prog_name="hello", prog_ifindex=0, expected_attach_type=BPF_CGROUP_INET_
INGRESS, prog_btf_fd=3, func_info_rec_size=8, func_info=0x29a995c0, func_info_cnt=1, line_info_rec_size=16, line_info=0x2ab3a570, line_in
fo_cnt=20, attach_btf_id=0, attach_prog_fd=0, fd_array=NULL}, 144) = 6

bpf(BPF_RAW_TRACEPOINT_OPEN, {raw_tracepoint={name="sys_enter", prog_fd=6}}, 16) = 7

bpf(BPF_MAP_UPDATE_ELEM, {map_fd=5, key=0x71ccc2aac1a0, value=0x71ccc6e93ea0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=5, key=0x71ccc2aac220, value=0x71ccc2aac1a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac2a0, value=0x71ccc2aac1a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac1a0, value=0x71ccc2aac2a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac2a0, value=0x71ccc2aac1a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac1a0, value=0x71ccc2aac2a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac2a0, value=0x71ccc2aac1a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac1a0, value=0x71ccc2aac2a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac2a0, value=0x71ccc2aac1a0, flags=BPF_ANY}, 32) = 0
bpf(BPF_MAP_UPDATE_ELEM, {map_fd=4, key=0x71ccc2aac320, value=0x71ccc2aac1a0, flags=BPF_ANY}, 32) = 0
```
