## Question 02

在示例代码的 `xdp_hello` 程序中找到被注释掉的循环代码块。尝试添加如下所示的第一个循环：

```c
for (int i=0; i < 10; i++) {
    bpf_printk("Looping %d", i);
}
```

你应该会在校验器日志中看到一段重复出现的内容，格式大致如下：

```sh
42: (18) r1 = 0xffff800008e10009
44: (b7) r2 = 11
45: (b7) r3 = 8
46: (85) call bpf_trace_printk#6
 R0=inv(id=0) R1_w=map_value(id=0,off=9,ks=4,vs=26,imm=0) R2_w=inv11
 R3_w=inv8 R6=pkt_end(id=0,off=0,imm=0) R7=pkt(id=0,off=0,r=0,imm=0) 
 R10=fp0
last_idx 46 first_idx 42
regs=4 stack=0 before 45: (b7) r3 = 8
regs=4 stack=0 before 44: (b7) r2 = 11
```

从这份日志中，找出哪个寄存器在跟踪循环变量 `i`。

## Answer

1. 修改代码

2. 编译运行

```sh
$ ./hello-verifier
...
; bpf_printk("Looping %d", i);
2: (18) r1 = 0xffffb05f4033f009       ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
4: (b7) r2 = 11                       ; R2_w=11
5: (b7) r3 = 0                        ; R3_w=0
6: (85) call bpf_trace_printk#6       ; R0_w=scalar()
7: (18) r1 = 0xffffb05f4033f009       ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
9: (b7) r2 = 11                       ; R2_w=11
10: (b7) r3 = 1                       ; R3_w=1
11: (85) call bpf_trace_printk#6      ; R0=scalar()
12: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
14: (b7) r2 = 11                      ; R2_w=11
15: (b7) r3 = 2                       ; R3_w=2
16: (85) call bpf_trace_printk#6      ; R0_w=scalar()
17: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
19: (b7) r2 = 11                      ; R2_w=11
20: (b7) r3 = 3                       ; R3_w=3
21: (85) call bpf_trace_printk#6      ; R0=scalar()
22: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
24: (b7) r2 = 11                      ; R2_w=11
25: (b7) r3 = 4                       ; R3_w=4
26: (85) call bpf_trace_printk#6      ; R0_w=scalar()
27: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
29: (b7) r2 = 11                      ; R2_w=11
30: (b7) r3 = 5                       ; R3_w=5
31: (85) call bpf_trace_printk#6      ; R0=scalar()
32: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
34: (b7) r2 = 11                      ; R2_w=11
35: (b7) r3 = 6                       ; R3_w=6
36: (85) call bpf_trace_printk#6      ; R0_w=scalar()
37: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
39: (b7) r2 = 11                      ; R2_w=11
40: (b7) r3 = 7                       ; R3_w=7
41: (85) call bpf_trace_printk#6      ; R0=scalar()
42: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
44: (b7) r2 = 11                      ; R2_w=11
45: (b7) r3 = 8                       ; R3_w=8
46: (85) call bpf_trace_printk#6      ; R0_w=scalar()
47: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
49: (b7) r2 = 11                      ; R2_w=11
50: (b7) r3 = 9                       ; R3_w=9
...
```

显然，R3 寄存器在跟踪循环变量 `i`。

<details>
<summary>完整输出信息</summary>

```sh
processed 49 insns (limit 1000000) max_states_per_insn 0 total_states 5 peak_states 5 mark_read 5
)(r1 +4)          ; R1=ctx(off=0,imm=0) R6_w=pkt_end(off=0,imm=0)
; void *data = (void *)(long)ctx->data;
1: (61) r7 = *(u32 *)(r1 +0)          ; R1=ctx(off=0,imm=0) R7_w=pkt(off=0,r=0,imm=0)
; bpf_printk("Looping %d", i);
2: (18) r1 = 0xffffb05f4033f009       ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
4: (b7) r2 = 11                       ; R2_w=11
5: (b7) r3 = 0                        ; R3_w=0
6: (85) call bpf_trace_printk#6       ; R0_w=scalar()
7: (18) r1 = 0xffffb05f4033f009       ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
9: (b7) r2 = 11                       ; R2_w=11
10: (b7) r3 = 1                       ; R3_w=1
11: (85) call bpf_trace_printk#6      ; R0=scalar()
12: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
14: (b7) r2 = 11                      ; R2_w=11
15: (b7) r3 = 2                       ; R3_w=2
16: (85) call bpf_trace_printk#6      ; R0_w=scalar()
17: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
19: (b7) r2 = 11                      ; R2_w=11
20: (b7) r3 = 3                       ; R3_w=3
21: (85) call bpf_trace_printk#6      ; R0=scalar()
22: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
24: (b7) r2 = 11                      ; R2_w=11
25: (b7) r3 = 4                       ; R3_w=4
26: (85) call bpf_trace_printk#6      ; R0_w=scalar()
27: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
29: (b7) r2 = 11                      ; R2_w=11
30: (b7) r3 = 5                       ; R3_w=5
31: (85) call bpf_trace_printk#6      ; R0=scalar()
32: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
34: (b7) r2 = 11                      ; R2_w=11
35: (b7) r3 = 6                       ; R3_w=6
36: (85) call bpf_trace_printk#6      ; R0_w=scalar()
37: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
39: (b7) r2 = 11                      ; R2_w=11
40: (b7) r3 = 7                       ; R3_w=7
41: (85) call bpf_trace_printk#6      ; R0=scalar()
42: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
44: (b7) r2 = 11                      ; R2_w=11
45: (b7) r3 = 8                       ; R3_w=8
46: (85) call bpf_trace_printk#6      ; R0_w=scalar()
47: (18) r1 = 0xffffb05f4033f009      ; R1_w=map_value(off=9,ks=4,vs=26,imm=0)
49: (b7) r2 = 11                      ; R2_w=11
50: (b7) r3 = 9                       ; R3_w=9
51: (85) call bpf_trace_printk#6      ; R0=scalar()
; bpf_printk("%x %x", data, data_end);
52: (18) r1 = 0xffffb05f4033f014      ; R1_w=map_value(off=20,ks=4,vs=26,imm=0)
54: (b7) r2 = 6                       ; R2_w=6
55: (bf) r3 = r7                      ; R3_w=pkt(off=0,r=0,imm=0) R7=pkt(off=0,r=0,imm=0)
56: (bf) r4 = r6                      ; R4_w=pkt_end(off=0,imm=0) R6=pkt_end(off=0,imm=0)
57: (85) call bpf_trace_printk#6      ; R0_w=scalar()
; return XDP_PASS;
58: (b7) r0 = 2                       ; R0_w=2
59: (95) exit
8_w=mmmmmmmm
;
40: (bf) r1 = r10                     ; R1_w=fp0 R10=fp0
41: (07) r1 += -12                    ; R1_w=fp-12
42: (b7) r2 = 12                      ; R2_w=12
43: (85) call bpf_probe_read_kernel#113       ; R0=scalar() fp-8=mmmmmmmm fp-16=mmmm0000
; if (c < sizeof(message)) {
44: (61) r1 = *(u32 *)(r7 +0)         ; R1_w=scalar(umax=4294967295,var_off=(0x0; 0xffffffff)) R7=map_value(off=0,ks=4,vs=16,imm=0)    
; if (c < sizeof(message)) {
45: (25) if r1 > 0xb goto pc+24
from 45 to 70: safe
ax=11,var_off=(0x0; 0xf))
; char a = message[c];
46: (18) r2 = 0xffffb05f4033c004      ; R2_w=map_value(off=4,ks=4,vs=16,imm=0)
48: (0f) r2 += r1                     ; R1_w=scalar(umax=11,var_off=(0x0; 0xf)) R2_w=map_value(off=4,ks=4,vs=16,umax=11,var_off=(0x0; 0
xf),s32_max=15,u32_max=15)
49: (71) r3 = *(u8 *)(r2 +0)          ; R2_w=map_value(off=4,ks=4,vs=16,umax=11,var_off=(0x0; 0xf),s32_max=15,u32_max=15) R3_w=scalar(u
max=255,var_off=(0x0; 0xff))
50: (67) r3 <<= 56                    ; R3_w=scalar(smax=9151314442816847872,umax=18374686479671623680,var_off=(0x0; 0xff00000000000000
),s32_min=0,s32_max=0,u32_max=0)
51: (c7) r3 s>>= 56                   ; R3_w=scalar(smin=-128,smax=127)
; bpf_printk("%c", a);
52: (18) r1 = 0xffffb05f4033f003      ; R1_w=map_value(off=3,ks=4,vs=26,imm=0)
54: (b7) r2 = 3                       ; R2_w=3
55: (85) call bpf_trace_printk#6

from 55 to 56: safe
value(off=4,ks=4,vs=16,umax=11,var_off=(0x0; 0xf),s32_max=15,u32_max=15)
49: (71) r3 = *(u8 *)(r2 +0)          ; R2_w=map_value(off=4,ks=4,vs=16,umax=11,var_off=(0x0; 0xf),s32_max=15,u32_max=15) R3_w=scalar(u
max=255,var_off=(0x0; 0xff))
50: (67) r3 <<= 56                    ; R3_w=scalar(smax=9151314442816847872,umax=18374686479671623680,var_off=(0x0; 0xff00000000000000
),s32_min=0,s32_max=0,u32_max=0)
51: (c7) r3 s>>= 56                   ; R3_w=scalar(smin=-128,smax=127)
; bpf_printk("%c", a);
52: (18) r1 = 0xffffb05f4033f003      ; R1_w=map_value(off=3,ks=4,vs=26,imm=0)
54: (b7) r2 = 3                       ; R2_w=3
55: (85) call bpf_trace_printk#6      ; R0=scalar()
; if (c < sizeof(data.message)) {
56: (18) r1 = 0xffffb05f4033c000      ; R1_w=map_value(off=0,ks=4,vs=16,imm=0)
58: (61) r1 = *(u32 *)(r1 +0)         ; R1_w=scalar(umax=4294967295,var_off=(0x0; 0xffffffff))
; if (c < sizeof(data.message)) {
59: (25) if r1 > 0xb goto pc+10
from 59 to 70: safe
ax=11,var_off=(0x0; 0xf))
60: (bf) r2 = r10                     ; R2_w=fp0 R10=fp0
; char a = data.message[c];
61: (07) r2 += -40                    ; R2_w=fp-40
62: (0f) r2 += r1                     ; R1_w=scalar(umax=11,var_off=(0x0; 0xf)) R2_w=fp(off=-40,umax=11,var_off=(0x0; 0xf),s32_max=15,u
32_max=15)
63: (71) r3 = *(u8 *)(r2 +28)         ; R2_w=fp(off=-40,umax=11,var_off=(0x0; 0xf),s32_max=15,u32_max=15) R3_w=scalar(umax=255,var_off=
(0x0; 0xff)) fp-16=mmmm0000
64: (67) r3 <<= 56                    ; R3_w=scalar(smax=9151314442816847872,umax=18374686479671623680,var_off=(0x0; 0xff00000000000000
),s32_min=0,s32_max=0,u32_max=0)
65: (c7) r3 s>>= 56                   ; R3_w=scalar(smin=-128,smax=127)
; bpf_printk("%c", a);
66: (18) r1 = 0xffffb05f4033f006      ; R1_w=map_value(off=6,ks=4,vs=26,imm=0)
68: (b7) r2 = 3                       ; R2_w=3
69: (85) call bpf_trace_printk#6      ; R0=scalar()
; bpf_get_current_comm(&data.command, sizeof(data.command));
70: (bf) r1 = r10                     ; R1_w=fp0 R10=fp0
71: (07) r1 += -28                    ; R1_w=fp-28
; bpf_get_current_comm(&data.command, sizeof(data.command));
72: (b7) r2 = 16                      ; R2_w=16
73: (85) call bpf_get_current_comm#16         ; R0_w=scalar() fp-16=mmmmmmmm fp-24=mmmmmmmm fp-32=mmmmmmmm
74: (bf) r4 = r10                     ; R4_w=fp0 R10=fp0
; bpf_get_current_comm(&data.command, sizeof(data.command));
75: (07) r4 += -40                    ; R4_w=fp-40
; bpf_perf_event_output(ctx, &output, BPF_F_CURRENT_CPU,  &data, sizeof(data));
76: (bf) r1 = r6                      ; R1_w=ctx(off=0,imm=0) R6=ctx(off=0,imm=0)
77: (18) r2 = 0xffff96bd00ec2000      ; R2_w=map_ptr(off=0,ks=4,vs=4,imm=0)
79: (18) r3 = 0xffffffff              ; R3_w=4294967295
81: (b7) r5 = 40                      ; R5_w=40
82: (85) call bpf_perf_event_output#25        ; R0=scalar()
; return 0;
83: (b7) r0 = 0                       ; R0_w=0
84: (95) exit
```

</details>
